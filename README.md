# RLT тестовое задание

Telegram-бот для аналитики по видео на основе задач на естественном языке.

## Описание

Бот принимает текстовые запросы на русском языке и возвращает числовые ответы на основе статистики по видео-креаторам. Данные хранятся в PostgreSQL и включают итоговую статистику по видео и почасовые снапшоты для отслеживания динамики.

## Требования

- Docker и Docker Compose
- Git
- Python 3.10+ (для локальной разработки)
- PostgreSQL 14+
- Redis 7+

## Установка и запуск

### Вариант 1: Запуск с Docker (рекомендуется)

1. Клонируйте репозиторий:
```bash
git clone <repository_url>
cd rlt-test-bot
```

2. Создайте файл `.env` в корне проекта:
```bash
cp env.example .env
```

3. Запустите контейнеры:
```bash
docker-compose up -d
```

5. Выполните миграции базы данных:
```bash
docker-compose exec app alembic upgrade head
```

6. Загрузите данные из JSON файла:
```bash
docker-compose exec app python scripts/load_data.py data/videos.json
```

### Поток обработки запроса

1. Пользователь отправляет текстовое сообщение боту
2. Бот отправляет запрос в FastAPI endpoint `/query/query`
3. FastAPI ставит задачу в ARQ очередь
4. ARQ Worker:
   - Отправляет запрос в LLM (GigaChat) для преобразования естественного языка в структурированный JSON
   - Выполняет SQL запрос через QueryService на основе JSON от LLM
   - Возвращает числовой результат
5. Бот отправляет результат пользователю

### Преобразование естественного языка в SQL

#### Подход

Используется двухэтапный подход:

1. **LLM (GigaChat)** преобразует естественный язык в структурированный JSON с параметрами запроса
2. **QueryService** строит и выполняет безопасный SQL запрос через SQLAlchemy ORM


## Технологии

- **Python 3.12**
- **FastAPI** - REST API
- **aiogram 3.4** - Telegram бот
- **PostgreSQL** - база данных
- **SQLAlchemy 2.0** - ORM
- **Alembic** - миграции БД
- **ARQ** - асинхронная очередь задач
- **Redis** - брокер сообщений для ARQ
- **GigaChat API** - LLM для обработки естественного языка
- **dateparser** - парсинг дат из естественного языка
